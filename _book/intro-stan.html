<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Appendice C Programmare in Stan | Data Science per psicologi</title>
  <meta name="description" content="Appendice C Programmare in Stan | Data Science per psicologi si propone di fornire un’introduzione all’analisi dei dati psicologici agli studenti del primo anno del Corso di Laurea in Scienze e Tecniche Psicologiche presso l’Università degli Studi di Firenze. Particolare attenzione sarà posta ai seguenti aspetti: l’uso del linguaggio R per lo svolgimento delle analisi statistiche, la rappresentazione grafica dei dati e l’inferenza Bayesiana." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Appendice C Programmare in Stan | Data Science per psicologi" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Appendice C Programmare in Stan | Data Science per psicologi si propone di fornire un’introduzione all’analisi dei dati psicologici agli studenti del primo anno del Corso di Laurea in Scienze e Tecniche Psicologiche presso l’Università degli Studi di Firenze. Particolare attenzione sarà posta ai seguenti aspetti: l’uso del linguaggio R per lo svolgimento delle analisi statistiche, la rappresentazione grafica dei dati e l’inferenza Bayesiana." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Appendice C Programmare in Stan | Data Science per psicologi" />
  
  <meta name="twitter:description" content="Appendice C Programmare in Stan | Data Science per psicologi si propone di fornire un’introduzione all’analisi dei dati psicologici agli studenti del primo anno del Corso di Laurea in Scienze e Tecniche Psicologiche presso l’Università degli Studi di Firenze. Particolare attenzione sarà posta ai seguenti aspetti: l’uso del linguaggio R per lo svolgimento delle analisi statistiche, la rappresentazione grafica dei dati e l’inferenza Bayesiana." />
  

<meta name="author" content="Corrado Caudek" />


<meta name="date" content="2021-10-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="integration-mc.html"/>

<script src="libs/header-attrs-2.11.2/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data Science per psicologi</a></li>

<li class="divider"></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html"><i class="fa fa-check"></i><b>A</b> Aspettative degli individui depressi</a>
<ul>
<li class="chapter" data-level="A.1" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html#la-griglia"><i class="fa fa-check"></i><b>A.1</b> La griglia</a></li>
<li class="chapter" data-level="A.2" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html#distribuzione-a-priori"><i class="fa fa-check"></i><b>A.2</b> Distribuzione a priori</a></li>
<li class="chapter" data-level="A.3" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html#funzione-di-verosimiglianza"><i class="fa fa-check"></i><b>A.3</b> Funzione di verosimiglianza</a></li>
<li class="chapter" data-level="A.4" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html#distribuzione-a-posteriori"><i class="fa fa-check"></i><b>A.4</b> Distribuzione a posteriori</a></li>
<li class="chapter" data-level="A.5" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html#es-depression-beta-2-10"><i class="fa fa-check"></i><b>A.5</b> La stima della distribuzione a posteriori (versione 2)</a></li>
<li class="chapter" data-level="A.6" data-path="es-pratico-zetsche.html"><a href="es-pratico-zetsche.html#es-pratico-zetsche-funzioni"><i class="fa fa-check"></i><b>A.6</b> Versione 2</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="integration-mc.html"><a href="integration-mc.html"><i class="fa fa-check"></i><b>B</b> Integrazione di Monte Carlo</a></li>
<li class="chapter" data-level="C" data-path="intro-stan.html"><a href="intro-stan.html"><i class="fa fa-check"></i><b>C</b> Programmare in Stan</a>
<ul>
<li class="chapter" data-level="C.1" data-path="intro-stan.html"><a href="intro-stan.html#che-cosè-stan"><i class="fa fa-check"></i><b>C.1</b> Che cos’è Stan?</a></li>
<li class="chapter" data-level="C.2" data-path="intro-stan.html"><a href="intro-stan.html#interfaccia-cmdstanr"><i class="fa fa-check"></i><b>C.2</b> Interfaccia <code>cmdstanr</code></a></li>
<li class="chapter" data-level="C.3" data-path="intro-stan.html"><a href="intro-stan.html#codice-stan"><i class="fa fa-check"></i><b>C.3</b> Codice Stan</a>
<ul>
<li class="chapter" data-level="C.3.1" data-path="intro-stan.html"><a href="intro-stan.html#blocco-data"><i class="fa fa-check"></i><b>C.3.1</b> Blocco <code>data</code></a></li>
<li class="chapter" data-level="C.3.2" data-path="intro-stan.html"><a href="intro-stan.html#blocco-parameters"><i class="fa fa-check"></i><b>C.3.2</b> Blocco <code>parameters</code></a></li>
<li class="chapter" data-level="C.3.3" data-path="intro-stan.html"><a href="intro-stan.html#blocco-model"><i class="fa fa-check"></i><b>C.3.3</b> Blocco <code>model</code></a></li>
<li class="chapter" data-level="C.3.4" data-path="intro-stan.html"><a href="intro-stan.html#blocchi-opzionali"><i class="fa fa-check"></i><b>C.3.4</b> Blocchi opzionali</a></li>
<li class="chapter" data-level="C.3.5" data-path="intro-stan.html"><a href="intro-stan.html#sintassi"><i class="fa fa-check"></i><b>C.3.5</b> Sintassi</a></li>
</ul></li>
<li class="chapter" data-level="C.4" data-path="intro-stan.html"><a href="intro-stan.html#workflow"><i class="fa fa-check"></i><b>C.4</b> Workflow</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Science per psicologi</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="intro-stan" class="section level1" number="3">
<h1><span class="header-section-number">Appendice C</span> Programmare in Stan</h1>
<!-- http://avehtari.github.io/BDA_R_demos/demos_rstan/rstan_demo.html -->
<div id="che-cosè-stan" class="section level2" number="3.1">
<h2><span class="header-section-number">C.1</span> Che cos’è Stan?</h2>
<p><a href="http://mc-stan.org/">STAN</a> è un linguaggio di programmazione probabilistico usato per l’inferenza bayesiana <span class="citation">(<a href="#ref-carpenter2017stan" role="doc-biblioref">Carpenter et al. 2017</a>)</span>. Prende il nome da uno dei creatori del metodo Monte Carlo, Stanislaw Ulam <span class="citation">(<a href="#ref-Eckhardt1987stan" role="doc-biblioref">Eckhardt 1987</a>)</span>. Stan consente di generare campioni da distribuzioni di probabilità basati sulla costruzione di una catena di Markov avente come distribuzione di equilibrio (o stazionaria) la distribuzione desiderata.</p>
<p>Nelle parole degli autori:</p>
<blockquote>
<p>Stan is a state-of-the-art platform for statistical modeling and high-performance statistical computation. Thousands of users rely on Stan for statistical modeling, data analysis, and prediction in the social, biological, and physical sciences, engineering, and business. Users specify log density functions in Stan’s probabilistic programming language and get: full Bayesian statistical inference with MCMC sampling (NUTS, HMC); approximate Bayesian inference with variational inference (ADVI): penalized maximum likelihood estimation with optimization (L-BFGS).</p>
</blockquote>
<p>È possibile accedere al linguaggio Stan tramite diverse interfacce:</p>
<ul>
<li><code>CmdStan</code>: eseguibile da riga di comando,</li>
<li><code>RStan</code> - integrazione con il linguaggio ;</li>
<li><code>PyStan</code> - integrazione con il linguaggio di programmazione Python;</li>
<li><code>MatlabStan</code> - integrazione con MATLAB;</li>
<li><code>Stan.jl</code> - integrazione con il linguaggio di programmazione Julia;</li>
<li><code>StataStan</code> - integrazione con Stata.</li>
</ul>
<p>Inoltre, vengono fornite interfacce di livello superiore con i pacchetti che utilizzano Stan come backend, principalmente in Linguaggio :</p>
<ul>
<li><code>shinystan</code>: interfaccia grafica interattiva per l’analisi della distribuzione a posteriori e le diagnostiche MCMC;<br />
</li>
<li><code>bayesplot</code>: insieme di funzioni utilizzabili per creare grafici relativi all’analisi della distribuzione a posteriori, ai test del modello e alle diagnostiche MCMC;<br />
</li>
<li><code>brms</code>: fornisce un’ampia gamma di modelli lineari e non lineari specificando i modelli statistici mediante la sintassi usata in ;</li>
<li><code>rstanarm</code>: fornisce un sostituto per i modelli frequentisti forniti da base <span class="math inline">\(\R\)</span> e <code>lme4</code> utilizzando la sintassi usata in <span class="math inline">\(\R\)</span> per la specificazione dei modelli statistici;</li>
<li><code>edstan</code>: modelli Stan per la Item Response Theory;</li>
<li><code>cmdstanr</code>, un’interfaccia <span class="math inline">\(\R\)</span> per <code>CmdStan</code>.</li>
</ul>
</div>
<div id="interfaccia-cmdstanr" class="section level2" number="3.2">
<h2><span class="header-section-number">C.2</span> Interfaccia <code>cmdstanr</code></h2>
<p>Negli esempi di questa dispensa verrà usata l’interfaccia <code>cmdstanr</code>. Il pacchetto <code>cmdstanr</code> non è ancora disponibile su CRAN, ma può essere installato come indicato su questo <a href="https://mc-stan.org/docs/2_27/cmdstan-guide/cmdstan-installation.html">link</a>. Una volta che è stato installato, il pacchetto <code>cmdstanr</code> può essere caricato come un qualsiasi altro pacchetto R.</p>
<p>Si noti che <code>cmdstanr</code> richiede un’installazione funzionante di <code>CmdStan</code>, l’interfaccia shell per Stan. Se <code>CmdStan</code> non è installato, <code>cmdstanr</code> lo installerà automaticamente se il computer dispone di una <em>Toolchain</em> adatta. Stan richiede infatti che sul computer su cui viene installato siano presenti alcuni strumenti necessari per gestire i file C++. Tra le altre ragioni, questo è dovuto al fatto che il codice Stan viene tradotto in codice C++ e compilato. Il modo migliore per ottenere il software necessario per un computer Windows o Mac è quello di installare <code>RTools</code>. Per un computer Linux, è necessario installare <code>build-essential</code> e una versione recente dei compilatori g++ o clang++. I requisiti sono descritti nella <a href="https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html">Guida di CmdStan</a>.</p>
<p>Per verificare che la Toolchain sia configurata correttamente è possibile utilizzare la funzione <code>check_cmdstan_toolchain()</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="intro-stan.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check_cmdstan_toolchain</span>()</span></code></pre></div>
<p>
Se la toolchain è configurata correttamente, <code>CmdStan</code> può essere installato mediante la funzione <code>install_cmdstan()</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="intro-stan.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># do not run!</span></span>
<span id="cb29-2"><a href="intro-stan.html#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install_cmdstan(cores = 2)</span></span></code></pre></div>
<p>
Prima di poter utilizzare <code>CmdStanR</code>, è necessario specificare dove si trova l’installazione di <code>CmdStan</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="intro-stan.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># do not run!</span></span>
<span id="cb30-2"><a href="intro-stan.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># set_cmdstan_path(PATH_TO_CMDSTAN)</span></span></code></pre></div>
<p>
Sul mio computer <code>PATH_TO_CMDSTAN</code> è la seguente stringa (incluse le virgolette):</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="intro-stan.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cmdstan_path</span>()</span>
<span id="cb31-2"><a href="intro-stan.html#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;/Users/corrado/.cmdstan/cmdstan-2.28.0&quot;</span></span></code></pre></div>
<p>
La versione installata di <code>CmdStan</code> si ottiene con:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="intro-stan.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cmdstan_version</span>()</span>
<span id="cb32-2"><a href="intro-stan.html#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2.28.0&quot;</span></span></code></pre></div>
</div>
<div id="codice-stan" class="section level2" number="3.3">
<h2><span class="header-section-number">C.3</span> Codice Stan</h2>
<p>Qualunque sia l’interfaccia che viene usata, i modelli sottostanti sono sempre scritti nel linguaggio Stan, il che significa che lo stesso codice Stan è valido per tutte le interfacce possibili. Il codice Stan è costituito da una serie di blocchi che vengono usati per specificare un modello statistico. In ordine, questi blocchi sono: <code>data</code>, <code>transformed data</code>, <code>parameters</code>, <code>transformed parameters</code>, <code>model</code>, e <code>generated quantities</code>.</p>
<p>Un programma Stan contiene tre “blocchi” obbligatori: blocco <code>data</code>, blocco <code>parameters</code>, blocco <code>model</code>.</p>
<div id="blocco-data" class="section level3" number="3.3.1">
<h3><span class="header-section-number">C.3.1</span> Blocco <code>data</code></h3>
<p>Qui vengono dichiarate le variabili che saranno passate a Stan. Devono essere elencati i nomi delle variabili che saranno utilizzate nel programma, il <em>tipo di dati</em> da registrare per ciascuna variabile, per esempio:
- <em>int</em> = intero,
- <em>real</em> = numeri reali (ovvero, numeri con cifre decimali),
- <em>vector</em> = sequenze ordinate di numeri reali unidimensionali,
- <em>matrix</em> = matrici bidimensionali di numeri reali,
- <em>array</em> = sequenze ordinate di dati multidimensionali.</p>
<p>Devono anche essere dichiarate le dimensioni delle variabili e le eventuali restrizioni sulle variabili (es. <code>upper = 1</code> <code>lower = 0</code>, che fungono da controlli per Stan). Tutti i nomi delle variabili assegnate qui saranno anche usati negli altri blocchi del programma.</p>
<p>Per esempio, l’istruzione seguente dichiaria la variabile <code>Y</code> – la quale rappresenta, ad esempio, l’altezza di 10 persone – come una variabile di tipo <code>real[10]</code>. Ciò significa che specifichiamo un array di lunghezza 10, i cui elementi sono variabili continue definite sull’intervallo dei numeri reali <span class="math inline">\([-\infty, +\infty]\)</span>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="intro-stan.html#cb33-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb33-2"><a href="intro-stan.html#cb33-2" aria-hidden="true" tabindex="-1"></a>  real Y[<span class="dv">10</span>]; <span class="sc">/</span><span class="er">/</span> heights <span class="cf">for</span> <span class="dv">10</span> people</span>
<span id="cb33-3"><a href="intro-stan.html#cb33-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Invece, con l’istruzione</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="intro-stan.html#cb34-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb34-2"><a href="intro-stan.html#cb34-2" aria-hidden="true" tabindex="-1"></a>  int Y[<span class="dv">10</span>]; <span class="sc">/</span><span class="er">/</span> qi <span class="cf">for</span> <span class="dv">10</span> people</span>
<span id="cb34-3"><a href="intro-stan.html#cb34-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>
dichiariamo la variabile <code>Y</code> – la quale rappresenta, ad esempio, il QI di 10 persone – come una variabile di tipo <code>int[10]</code>, ovvero un array di lunghezza 10, i cui elementi sono numeri naturali, cioè numeri interi non negativi <span class="math inline">\(\{0, +1, +2, +3, +4, \dots\}\)</span>.</p>
<p>Un altro esempio è</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="intro-stan.html#cb35-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb35-2"><a href="intro-stan.html#cb35-2" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span>, upper<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> Y[<span class="dv">10</span>]; <span class="sc">/</span><span class="er">/</span> <span class="dv">10</span> proportions</span>
<span id="cb35-3"><a href="intro-stan.html#cb35-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>
nel quale viene specificato un array di lunghezza 10, i cui elementi sono delle variabili continue definite sull’intervallo dei numeri reali <span class="math inline">\([0, 1]\)</span> — per esempio, delle proporzioni.</p>
<p>Si noti che i tipi <code>vector</code> e <code>matrix</code> contengono solo elementi di tipo <code>real</code>, ovvero variabili continue, mentre gli <code>array</code> possono contenere dati di qualsiasi tipo. I dati passati a Stan devono essere contenuti in un oggetto del tipo <code>list</code>.</p>
</div>
<div id="blocco-parameters" class="section level3" number="3.3.2">
<h3><span class="header-section-number">C.3.2</span> Blocco <code>parameters</code></h3>
<p>I parametri che vengono stimati sono dichiarati nel blocco <code>parameters</code>. Per esempio, l’istruzione</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="intro-stan.html#cb36-1" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb36-2"><a href="intro-stan.html#cb36-2" aria-hidden="true" tabindex="-1"></a>  real mu; <span class="sc">/</span><span class="er">/</span> mean height <span class="cf">in</span> population</span>
<span id="cb36-3"><a href="intro-stan.html#cb36-3" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma; <span class="sc">/</span><span class="er">/</span> sd of height distribution</span>
<span id="cb36-4"><a href="intro-stan.html#cb36-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>
dichiaria la variabile <code>mu</code> che codifica l’altezza media nella popolazione, che è una variabile continua in un intervallo illimitato di valori, e la deviazione standard <code>sigma</code>, che è una variabile continua non negativa. Avremmo anche potuto specificare un limite inferiore di zero su <code>mu</code> perché deve essere non negativo.</p>
<p>Per una regressione lineare semplice, ad esempio, devono essere dichiarate le variabili corrispondenti all’intercetta (<code>alpha</code>), alla pendenza (<code>beta</code>) e alla deviazione standard degli errori attorno alla linea di regressione (<code>sigma</code>). In altri termini, nel blocco <code>parameters</code> devono essere elencati tutti i parametri che dovranno essere stimati dal modello. Si noti che parametri discreti non sono possibili. Infatti, Stan attualmente non supporta i parametri con valori interi, almeno non direttamente.</p>
</div>
<div id="blocco-model" class="section level3" number="3.3.3">
<h3><span class="header-section-number">C.3.3</span> Blocco <code>model</code></h3>
<p>Nel blocco <code>model</code> vengono elencate le dichiarazioni relative alla verosimiglianza dei dati e alle distribuzioni a priori dei parametri, come ad esempio, nelle istruzioni seguenti.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="intro-stan.html#cb37-1" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb37-2"><a href="intro-stan.html#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb37-3"><a href="intro-stan.html#cb37-3" aria-hidden="true" tabindex="-1"></a>    Y[i] <span class="sc">~</span> <span class="fu">normal</span>(mu, sigma);</span>
<span id="cb37-4"><a href="intro-stan.html#cb37-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-5"><a href="intro-stan.html#cb37-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">170</span>, <span class="dv">15</span>); <span class="sc">/</span><span class="er">/</span> prior <span class="cf">for</span> mu</span>
<span id="cb37-6"><a href="intro-stan.html#cb37-6" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">20</span>); <span class="sc">/</span><span class="er">/</span> prior <span class="cf">for</span> sigma</span>
<span id="cb37-7"><a href="intro-stan.html#cb37-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>
Mediante l’istruzione all’interno del ciclo <code>for</code>, ciascun valore dell’altezza viene concepito come una variable casuale proveniente da una distribuzione Normale di parametri <span class="math inline">\(\mu\)</span> e <span class="math inline">\(\sigma\)</span> (i parametri di interesse nell’inferenza). Il ciclo <code>for</code> viene ripetuto 10 volte perché i dati sono costituiti da un array di 10 elementi (ovvero, il campione è costituito da 10 osservazioni).</p>
<p>Le due righe che seguno il ciclo <code>for</code> specificano le distribuzioni a priori dei parametri su cui vogliamo effettuare l’inferenza. Per <span class="math inline">\(\mu\)</span> assumiamo una distribuzione a priori Normale di parametri <span class="math inline">\(\mu = 170\)</span> e <span class="math inline">\(\sigma = 15\)</span>; per <span class="math inline">\(\sigma\)</span> assumiamo una distribuzione a priori Cauchy(0, 20).</p>
<p>Se non viene definita alcuna distribuzione a priori, Stan utilizzerà la distribuzione a priori predefinita <span class="math inline">\(Unif(-\infty, +\infty)\)</span>. Raccomandazioni sulle distribuzioni a priori sono fornite in questo <a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">link</a>.</p>
<p>La precedente notazione di campionamento può anche essere espressa usando la seguente notazione alternativa:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="intro-stan.html#cb38-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb38-2"><a href="intro-stan.html#cb38-2" aria-hidden="true" tabindex="-1"></a>    target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_lpdf</span>(Y[i] <span class="sc">|</span> mu, sigma);</span>
<span id="cb38-3"><a href="intro-stan.html#cb38-3" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>
Questa notazione rende trasparente il fatto che, in pratica, Stan esegue un campionamento nello spazio
<span class="math display">\[
\log p(\theta \mid y) \propto \log p(y \mid \theta) + \log p(\theta) = \sum_{i=1}^n \log p(y_i \mid \theta) + \log p(\theta).
\]</span>
Per ogni passo MCMC, viene ottenuto un nuovo valore di <span class="math inline">\(\mu\)</span> e <span class="math inline">\(\sigma\)</span> eviene valutata la log densità a posteriori non normalizzata. Ad ogni passo MCMC, Stan calcola un nuovo valore della densità a posteriori su scala logaritmica partendo da un valore di 0 e incrementandola ogni volta che incontra un’istruzione <code>~</code>. Quindi, le istruzioni precedenti aumentano la log-densità di una quantità pari a <span class="math inline">\(\log (p(Y[i])) \propto -\frac{1}{2} \log(\sigma^2) - (Y[i]-\mu)^2 / 2\sigma^2\)</span> per le altezze si ciascuno degli <span class="math inline">\(i=1 \dots, 10\)</span> individui – laddove la formula esprime, in termini logaritmici, la densità Normale da cui sono stati esclusi i termini costanti.</p>
<p>Oppure, in termini vettorializzati, il modello descritto sopra può essere espresso come</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="intro-stan.html#cb39-1" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb39-2"><a href="intro-stan.html#cb39-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> <span class="fu">normal</span>(mu, sigma);</span>
<span id="cb39-3"><a href="intro-stan.html#cb39-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>
dove il termine a sinistra di <span class="math inline">\(\sim\)</span> è un array. Questa notazione più compatta è anche la più efficiente.</p>
</div>
<div id="blocchi-opzionali" class="section level3" number="3.3.4">
<h3><span class="header-section-number">C.3.4</span> Blocchi opzionali</h3>
<p>Ci sono inoltre tre blocchi opzionali:</p>
<ul>
<li><p>Il blocco <code>transformed data</code> consente il pre-processing dei dati. È possibile trasformare i parametri del modello; solitamente ciò viene fatto nel caso dei modelli più avanzati per consentire un campionamento MCMC più efficiente.</p></li>
<li><p>Il blocco <code>transformed parameters</code> consente la manipolazione dei parametri prima del calcolo della distribuzione a posteriori.</p></li>
<li><p>Il blocco <code>generated quantities</code> consente il post-processing riguardante qualsiasi quantità che non fa parte del modello ma può essere calcolata a partire dai parametri del modello, per ogni iterazione dell’algoritmo. Esempi includono la generazione dei campioni a posteriori e le dimensioni degli effetti.</p></li>
</ul>
</div>
<div id="sintassi" class="section level3" number="3.3.5">
<h3><span class="header-section-number">C.3.5</span> Sintassi</h3>
<p>Si noti che il codice Stan richiede i punti e virgola (;) alla fine di ogni istruzione di assegnazione. Questo accade per le dichiarazioni dei dati, per le dichiarazioni dei parametri e ovunque si acceda ad un elemento di un tipo <code>data</code> e lo si assegni a qualcos’altro. I punti e virgola non sono invece richiesti all’inizio di un ciclo o di un’istruzione condizionale, dove non viene assegnato nulla.</p>
<p>In STAN, qualsiasi stringa che segue <code>//</code> denota un commento e viene ignorata dal programma.</p>
<p>Stan è un linguaggio estremamente potente e consente di implementare quasi tutti i modelli statistici, ma al prezzo di un certo sforzo di programmazione. Anche l’adattamento di semplici modelli statistici mediante il linguaggio STAN a volte può essere laborioso. Per molti modelli comunemente usati, come i modelli di regressione e multilivello, tale processo può essere semplificato usando le funzioni del pacchetto <code>brms</code>. D’altra parte, per modelli veramente complessi, non ci sono molte alternative all’uso di STAN. Per chi è curioso, il manuale del linguaggio Stan è accessibile al seguente <a href="https://mc-stan.org/docs/2_27/stan-users-guide/index.html">link</a>.</p>
</div>
</div>
<div id="workflow" class="section level2" number="3.4">
<h2><span class="header-section-number">C.4</span> Workflow</h2>
<p>Se usiamo <code>cmdstanr</code>, dobbiamo prima scrivere il codice con il modello, poi compilare il codice con la funzione <code>cmdstan_model()</code>, poi eseguire il campionamento MCMC con il metodo <code>$sample()</code> e, infine, creare un sommario dei risultati usando, per esempio, usando il metodo <code>$summary()</code>.</p>

<div id="refs" class="references csl-bib-body hanging-indent">
<div class="csl-entry">
Carpenter, Bob, Andrew Gelman, Matthew D Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. <span>“Stan: A Probabilistic Programming Language.”</span> <em>Journal of Statistical Software</em> 76 (1): 1–32.
</div>
<div class="csl-entry">
Eckhardt, Roger. 1987. <span>“<span class="nocase">Stan Ulam, John Von Neumann and the Monte Carlo Method</span>.”</span> <em>Los Alamos Science Special Issue</em>.
</div>
<div class="csl-entry">
Zetsche, Ulrike, Paul-Christian Bürkner, and Babette Renneberg. 2019. <span>“Future Expectations in Clinical Depression: <span>Biased</span> or Realistic?”</span> <em>Journal of Abnormal Psychology</em> 128 (7): 678–88.
</div>
</div>
</div>
</div>






<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-carpenter2017stan" class="csl-entry">
Carpenter, Bob, Andrew Gelman, Matthew D Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. <span>“Stan: A Probabilistic Programming Language.”</span> <em>Journal of Statistical Software</em> 76 (1): 1–32.
</div>
<div id="ref-Eckhardt1987stan" class="csl-entry">
Eckhardt, Roger. 1987. <span>“<span class="nocase">Stan Ulam, John Von Neumann and the Monte Carlo Method</span>.”</span> <em>Los Alamos Science Special Issue</em>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="integration-mc.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/914_programmare_in_stan.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Data Science per psicologi.pdf", "Data Science per psicologi.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
